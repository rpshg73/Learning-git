Version 4 code here.